<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Bảng Khảo Sát Chi Phí Sinh Hoạt</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
        }
        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
            font-size: 12pt;
            line-height: 1.5;
            margin: 0;
            padding: 0;
            background-color: #f9f9f9;
            color: #333;
        }
        .container {
            width: 100%;
            max-width: 21cm;
            background-color: white;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            padding: 20px;
            border-radius: 8px;
            margin: 20px auto;
        }
        .header {
            text-align: center;
            font-weight: 700;
            font-size: 24pt;
            margin-bottom: 30px;
            color: #1a5276;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 2px solid #1a5276;
            padding-bottom: 15px;
        }
        .logo {
            text-align: center;
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 25px;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #2980b9;
            color: white;
            font-weight: 600;
        }
        .section-title {
            font-weight: bold;
            background-color: #3498db;
            color: white;
            padding: 12px;
            font-size: 14pt;
        }
        tr:nth-child(even) {
            background-color: #f2f7fa;
        }
        tr:hover {
            background-color: #e8f4fc;
        }
        @media print {
            body {
                width: 21cm;
                height: 29.7cm;
                background-color: white;
            }
            .container {
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            #printBtn { display: none !important; }
        }
    </style>
</head>
<body>
    <button id="printBtn" style="position: fixed; top: 30px; right: 40px; z-index: 9999; background: #2980b9; color: #fff; border: none; border-radius: 6px; padding: 12px 28px; font-size: 1.1rem; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.13); cursor: pointer;">
        <i class="fas fa-print" style="margin-right:8px;"></i>In
    </button>
    <div id="dataWarning" style="display:none;color:#fff;background:#e74c3c;padding:12px 20px;border-radius:6px;margin:20px auto 0 auto;max-width:21cm;font-weight:bold;text-align:center;"></div>
    <div class="container">
        <div class="logo">
            <img src="logo.png" alt="Logo" style="height:80px;">
        </div>
        <div class="header">BẢNG KHẢO SÁT CHI PHÍ SINH HOẠT</div>
        
        <!-- Thông tin cá nhân -->
        <table>
            <tr>
                <th colspan="4" class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                        <path fill="white" d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z" />
                    </svg>
                    Thông tin cá nhân
                </th>
            </tr>
            <tr>
                <td><strong>Họ và tên</strong></td>
                <td id="Ho_Ten"></td>
                <td><strong>Điện thoại</strong></td>
                <td id="Dien_Thoai"></td>
            </tr>
            <tr>
                <td><strong>Vị trí công việc</strong></td>
                <td id="Vi_Tri"></td>
                <td><strong>Địa chỉ</strong></td>
                <td id="Dia_Chi"></td>
            </tr>
            <tr>
                <td><strong>Người lớn</strong></td>
                <td id="Nguoi_Lon"></td>
                <td><strong>Trẻ em</strong></td>
                <td id="Tre_Em"></td>
            </tr>
            <tr>
                <td><strong>Tổng thành viên</strong></td>
                <td colspan="3" id="Tong_Thanh_Vien"></td>
            </tr>
        </table>
        
        <!-- 1. Nhà ở -->
        <table>
            <tr>
                <th colspan="2" class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                        <path fill="white" d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z" />
                    </svg>
                    1. Nhà ở
                </th>
            </tr>
            <tr>
                <td><strong>Loại nhà ở</strong></td>
                <td id="Loai_Nha_O"></td>
            </tr>
            <tr>
                <td><strong>Chi phí nhà ở</strong></td>
                <td id="Chi_Phi_Nha_O"></td>
            </tr>
        </table>
        
        <!-- 2. Thực phẩm -->
        <table>
            <tr>
                <th colspan="4" class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                        <path fill="white" d="M15.5,21L14,8H16.23L15.1,3.46L16.84,3L18.09,8H22L20.5,21H15.5M5,11H10A3,3 0 0,1 13,14H2A3,3 0 0,1 5,11M13,18V21H2V18H13M2,16H13V14H2V16Z" />
                    </svg>
                    2. Thực phẩm
                </th>
            </tr>
            <tr>
                <th>Mặt hàng</th>
                <th>Chi phí</th>
                <th>Mặt hàng</th>
                <th>Chi phí</th>
            </tr>
            <tr>
                <td>Gạo</td>
                <td id="Gao"></td>
                <td>Thịt</td>
                <td id="Thit"></td>
            </tr>
            <tr>
                <td>Cá/hải sản</td>
                <td id="Ca"></td>
                <td>Rau củ</td>
                <td id="Rau_Cu"></td>
            </tr>
            <tr>
                <td>Sữa</td>
                <td id="Sua"></td>
                <td>Dầu ăn/Gia vị</td>
                <td id="Gia_Vi"></td>
            </tr>
        </table>
        
        <!-- 3. Giáo dục -->
        <table>
            <tr>
                <th colspan="4" class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                        <path fill="white" d="M12,3L1,9L12,15L21,10.09V17H23V9M5,13.18V17.18L12,21L19,17.18V13.18L12,17L5,13.18Z" />
                    </svg>
                    3. Giáo dục
                </th>
            </tr>
            <tr>
                <th>Khoản mục</th>
                <th>Chi phí</th>
                <th>Khoản mục</th>
                <th>Chi phí</th>
            </tr>
            <tr>
                <td>Học phí</td>
                <td id="Hoc_Phi"></td>
                <td>Sách vở</td>
                <td id="Sach_Vo"></td>
            </tr>
            <tr>
                <td>Đồng phục</td>
                <td id="Dong_Phuc"></td>
                <td>Chi phí khác (giáo dục)</td>
                <td id="Khac_Giao_Duc"></td>
            </tr>
        </table>
        
        <!-- 4. Tiện ích -->
        <table>
            <tr>
                <th colspan="4" class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                        <path fill="white" d="M19,5V7H15V5H19M9,5V11H5V5H9M19,13V19H15V13H19M9,17V19H5V17H9M21,3H13V9H21V3M11,3H3V13H11V3M21,11H13V21H21V11M11,15H3V21H11V15Z" />
                    </svg>
                    4. Tiện ích
                </th>
            </tr>
            <tr>
                <th>Khoản mục</th>
                <th>Chi phí</th>
                <th>Khoản mục</th>
                <th>Chi phí</th>
            </tr>
            <tr>
                <td>Điện</td>
                <td id="Dien"></td>
                <td>Nước</td>
                <td id="Nuoc"></td>
            </tr>
            <tr>
                <td>Internet/Điện thoại</td>
                <td id="Internet"></td>
                <td>Rác</td>
                <td id="Rac"></td>
            </tr>
        </table>
        
        <!-- 5. Tổng chi phí và thu nhập -->
        <table>
            <tr>
                <th colspan="4" class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                        <path fill="white" d="M11.8,10.9C9.53,10.31 8.8,9.7 8.8,8.75C8.8,7.66 9.81,6.9 11.5,6.9C13.28,6.9 13.94,7.75 14,9H16.21C16.14,7.28 15.09,5.7 13,5.19V3H10V5.16C8.06,5.58 6.5,6.84 6.5,8.77C6.5,11.08 8.41,12.23 11.2,12.9C13.7,13.5 14.2,14.38 14.2,15.31C14.2,16 13.71,17.1 11.5,17.1C9.44,17.1 8.63,16.18 8.5,15H6.32C6.44,17.19 8.08,18.42 10,18.83V21H13V18.85C14.95,18.5 16.5,17.35 16.5,15.3C16.5,12.46 14.07,11.5 11.8,10.9Z" />
                    </svg>
                    5. Tổng chi phí và thu nhập
                </th>
            </tr>
            <tr>
                <th>Khoản mục</th>
                <th>Chi phí/Thu nhập</th>
                <th>Khoản mục</th>
                <th>Chi phí/Thu nhập</th>
            </tr>
            <tr>
                <td><strong>Tổng chi phí</strong></td>
                <td id="Tong_Chi_Phi"></td>
                <td><strong>Thu nhập chính</strong></td>
                <td id="Thu_Nhap_Chinh"></td>
            </tr>
            <tr>
                <td><strong>Thu nhập phụ</strong></td>
                <td id="Thu_Nhap_Phu"></td>
                <td><strong>Tổng thu nhập</strong></td>
                <td id="Tong_Thu_Nhap"></td>
            </tr>
            <tr>
                <td><strong>Chênh lệch thu chi</strong></td>
                <td colspan="3" id="Chenh_Lech" style="font-weight: bold;"></td>
            </tr>
        </table>
        
        <!-- Xác nhận -->
        <table>
            <tr>
                <th colspan="3" class="section-title">
                    <svg width="18" height="18" viewBox="0 0 24 24" style="vertical-align: middle; margin-right: 10px;">
                        <path fill="white" d="M23,12L20.56,9.22L20.9,5.54L17.29,4.72L15.4,1.54L12,3L8.6,1.54L6.71,4.72L3.1,5.53L3.44,9.21L1,12L3.44,14.78L3.1,18.47L6.71,19.29L8.6,22.47L12,21L15.4,22.46L17.29,19.28L20.9,18.46L20.56,14.78L23,12M10,17L6,13L7.41,11.59L10,14.17L16.59,7.58L18,9L10,17Z" />
                    </svg>
                    Xác nhận
                </th>
            </tr>
            <tr>
                <td>Ngày khảo sát</td>
                <td colspan="2" id="Ngay_Khao_Sat"></td>
            </tr>
            <tr>
                <td>Chữ ký người khai</td>
                <td colspan="2" style="height: 60px;"></td>
            </tr>
        </table>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/js/all.min.js"></script>
    <script>
    function getData() {
        const params = new URLSearchParams(window.location.search);
        let data = {};
        
        // Phương thức 1: Lấy từ tham số 'data' dạng JSON 
        if (params.has('data')) {
            try {
                data = JSON.parse(decodeURIComponent(params.get('data')));
                return data;
            } catch (e) {
                console.error("Lỗi khi parse JSON:", e);
            }
        }
        
        // Phương thức 2: Lấy từ các tham số URL riêng lẻ
        const fieldNames = [
            'Ho_Ten', 'Dien_Thoai', 'Vi_Tri', 'Dia_Chi', 'Nguoi_Lon', 'Tre_Em', 
            'Tong_Thanh_Vien', 'Loai_Nha_O', 'Chi_Phi_Nha_O', 'Gao', 'Thit', 'Ca', 
            'Rau_Cu', 'Sua', 'Gia_Vi', 'Hoc_Phi', 'Sach_Vo', 'Dong_Phuc', 
            'Khac_Giao_Duc', 'Dien', 'Nuoc', 'Internet', 'Rac', 'Tong_Chi_Phi', 
            'Thu_Nhap_Chinh', 'Thu_Nhap_Phu', 'Tong_Thu_Nhap'
        ];
        
        fieldNames.forEach(field => {
            if (params.has(field)) {
                data[field] = params.get(field);
            }
        });
        
        // Phương thức 3: Thử lấy từ localStorage
        if (Object.keys(data).length === 0 && window.localStorage) {
            try {
                const storedData = localStorage.getItem('khaosat_data');
                if (storedData) {
                    data = JSON.parse(storedData);
                }
            } catch (e) {
                console.error("Lỗi khi đọc từ localStorage:", e);
            }
        }
        
        return data;
    }
    
    function formatNumber(val) {
        if (!val) return '';
        
        // Xử lý nếu val là chuỗi số đã có định dạng
        if (typeof val === 'string') {
            // Loại bỏ tất cả các dấu phân cách hiện có
            val = val.replace(/[.,\s]/g, '');
        }
        
        // Chuyển đổi thành số
        let num = parseFloat(val);
        if (isNaN(num)) return val;
        
        // Định dạng số theo tiêu chuẩn Việt Nam
        return num.toLocaleString('vi-VN');
    }
    
    function calculateDifference(income, expense) {
        // Loại bỏ các ký tự định dạng
        income = income ? income.toString().replace(/[.,\s]/g, '') : "0";
        expense = expense ? expense.toString().replace(/[.,\s]/g, '') : "0";
        
        // Chuyển đổi thành số
        let incomeNum = parseFloat(income);
        let expenseNum = parseFloat(expense);
        
        if (isNaN(incomeNum)) incomeNum = 0;
        if (isNaN(expenseNum)) expenseNum = 0;
        
        return incomeNum - expenseNum;
    }
    
    function fillData(data) {
        console.log("Dữ liệu đang xử lý:", data);
        
        // Các trường cần định dạng số
        const moneyFields = [
            'Chi_Phi_Nha_O', 'Gao', 'Thit', 'Ca', 'Rau_Cu', 'Sua', 'Gia_Vi', 
            'Hoc_Phi', 'Sach_Vo', 'Dong_Phuc', 'Khac_Giao_Duc', 'Dien', 'Nuoc', 
            'Internet', 'Rac', 'Tong_Chi_Phi', 'Thu_Nhap_Chinh', 'Thu_Nhap_Phu', 'Tong_Thu_Nhap'
        ];
        
        let missingFields = [];
        
        // Điền dữ liệu vào các trường
        for (const [key, value] of Object.entries(data)) {
            const element = document.getElementById(key);
            if (element) {
                if (moneyFields.includes(key)) {
                    element.textContent = formatNumber(value);
                } else {
                    element.textContent = value || '';
                }
            } else {
                // Trường hợp ID không tồn tại trong DOM
                missingFields.push(key);
            }
        }
        
        // Tính chênh lệch thu chi
        if (data.Tong_Thu_Nhap && data.Tong_Chi_Phi) {
            const chenhLech = calculateDifference(data.Tong_Thu_Nhap, data.Tong_Chi_Phi);
            const chenhLechElement = document.getElementById('Chenh_Lech');
            
            if (chenhLechElement) {
                chenhLechElement.textContent = formatNumber(chenhLech);
                
                // Đổi màu cho chênh lệch
                if (chenhLech < 0) {
                    chenhLechElement.style.color = 'red';
                } else {
                    chenhLechElement.style.color = 'green';
                }
            }
        }
        
        // Hiển thị cảnh báo nếu có trường dữ liệu bị thiếu
        if (missingFields.length > 0) {
            const warning = document.getElementById('dataWarning');
            if (warning) {
                warning.style.display = 'block';
                warning.textContent = `Cảnh báo: Các trường sau không tìm thấy trong form: ${missingFields.join(', ')}`;  
            }
        }
        
        // Điền ngày khảo sát nếu chưa có
        const ngayKhaoSatElement = document.getElementById('Ngay_Khao_Sat');
        if (ngayKhaoSatElement && !ngayKhaoSatElement.textContent) {
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            ngayKhaoSatElement.textContent = `${day}/${month}/${year}`;
        }
    }
    
    // Chạy khi trang đã tải xong
    document.addEventListener('DOMContentLoaded', function() {
        // Để debug
        console.log("DOM loaded, fetching data");
        
        const data = getData();
        console.log("Fetched data:", data);
        
        if (Object.keys(data).length === 0) {
            document.getElementById('dataWarning').style.display = 'block';
            document.getElementById('dataWarning').textContent = 'Không có dữ liệu khảo sát để hiển thị. Vui lòng kiểm tra URL hoặc cung cấp dữ liệu hợp lệ.';
        } else {
            fillData(data);
        }
        
        // Kích hoạt chức năng in
        document.getElementById('printBtn').addEventListener('click', function() {
            window.print();
        });
    });
    </script>
</body>
</html>
