<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo khảo sát</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/darkmode.css">
    <style>
        body { background: #f8f9fa; }
        .sidebar-filter {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 1.2rem 1rem 1rem 1rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s;
        }
        .ks-darkmode .sidebar-filter {
            background: #23272b !important;
        }
        .sidebar-filter-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            color: #0d6efd;
            margin-bottom: 0.7rem;
        }
        .sidebar-filter-content { display: block; }
        .sidebar-filter-content.hide { display: none; }
        .table-responsive { border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.07); }
        .ks-darkmode .table-responsive { background: #23272b !important; }
        table.table { border-collapse: separate; border-spacing: 0; }
        th, td { vertical-align: middle !important; }
        th { cursor: pointer; user-select: none; font-weight: 700; border-bottom: 2px solid #e5eaf2; }
        tr { transition: background 0.2s; }
        tr:hover { background: #f0f6ff; }
        td { border-bottom: 1px solid #f0f0f0; }
        .action-btns button { margin-right: 0.3rem; }
        .home-button { position: fixed; bottom: 30px; right: 30px; z-index: 99; }
        .btn-home { width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; }
        .btn-home:hover { transform: scale(1.1); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4); }
        .report-logo { height: 48px; margin-bottom: 8px; }
        .report-title { font-size: 1.3rem; font-weight: bold; color: #0d6efd; margin-bottom: 0.5rem; }
        .report-company { font-size: 1.1rem; color: #333; margin-bottom: 0.5rem; }
        .report-section { margin-bottom: 0.7rem; }
        .report-sign { margin-top: 2.5rem; display: flex; justify-content: space-between; }
        .report-sign .sign-box { width: 45%; text-align: center; }
        .report-sign .sign-label { font-style: italic; color: #888; }
        .report-sign .sign-space { height: 60px; border-bottom: 1px dotted #bbb; margin-bottom: 0.3rem; }
        .watermark-logo { position: absolute; opacity: 0.08; left: 50%; top: 50%; transform: translate(-50%,-50%); width: 300px; z-index: 0; }
        .navbar-custom {
            background: #fff;
            border-radius: 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 0.2rem 0.5rem;
            min-height: 60px;
            display: flex;
            align-items: center;
            border-bottom: 1.5px solid #e5eaf2;
        }
        .ks-darkmode .navbar-custom { background: #23272b !important; }
        .navbar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            min-height: 48px;
        }
        .navbar-left {
            display: flex;
            align-items: center;
            gap: 0.7rem;
            height: 48px;
        }
        .navbar-logo {
            height: 40px;
            width: auto;
            display: block;
            object-fit: contain;
        }
        .navbar-title-text {
            font-size: 1.5rem;
            font-weight: 900;
            color: #0d6efd;
            letter-spacing: 0.5px;
            margin: 0;
            line-height: 32px;
            display: flex;
            align-items: center;
            height: 32px;
        }
        .navbar-menu {
            display: flex;
            align-items: center;
            gap: 1.2rem;
            background: none;
            border-radius: 0;
            box-shadow: none;
            padding: 0;
            margin-right: 0.5rem;
        }
        .navbar-menu a {
            color: #333;
            font-size: 1.13rem;
            font-weight: 600;
            padding: 0.2rem 0.2rem 0.2rem 0.2rem;
            border-radius: 0;
            text-decoration: none;
            background: none;
            border: none;
            border-bottom: 2.5px solid transparent;
            transition: border-bottom 0.25s cubic-bezier(.4,0,.2,1), color 0.2s;
            cursor: pointer;
            letter-spacing: 0.2px;
            position: relative;
            line-height: 2.2rem;
            margin-left: 0.5rem;
            margin-right: 0.5rem;
        }
        .navbar-menu a.active, .navbar-menu a:hover {
            color: #0d6efd;
            border-bottom: 2.5px solid #0d6efd;
            background: none;
        }
        .navbar-account {
            position: relative;
            margin-left: 1.5rem;
        }
        .account-toggle {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-weight: 600;
            color: #0d6efd;
            gap: 0.4rem;
            font-size: 1.08rem;
        }
        .account-toggle i.fa-user-circle {
            font-size: 1.5rem;
        }
        .account-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 120%;
            background: #fff;
            min-width: 160px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.13);
            border-radius: 8px;
            z-index: 2000;
            padding: 0.5rem 0.2rem;
        }
        .ks-darkmode .account-dropdown { background: #23272b !important; }
        .account-dropdown.show { display: block; }
        .account-dropdown a {
            display: block;
            color: #222;
            padding: 0.5rem 1rem;
            text-decoration: none;
            border-radius: 6px;
            font-size: 1rem;
        }
        .account-dropdown a:hover {
            background: #f0f6ff;
            color: #0d6efd;
        }
        @media (max-width: 991.98px) {
            .navbar-content {
                flex-direction: row;
            }
            .navbar-menu {
                display: none;
                position: absolute;
                top: 56px;
                right: 10px;
                background: #fff;
                border-radius: 0;
                flex-direction: column;
                min-width: 180px;
                box-shadow: 0 4px 16px rgba(0,0,0,0.12);
                z-index: 1000;
                padding: 0.5rem 0.2rem;
                border: 1px solid #e5eaf2;
            }
            .navbar-menu.show {
                display: flex;
            }
            .navbar-menu a {
                margin: 0.2rem 0;
                font-size: 1.08rem;
                border-bottom: 1.5px solid transparent;
            }
        }
        .report-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .ks-darkmode .report-tabs { background: #23272b !important; }
        .report-tab {
            padding: 0.6rem 1.5rem;
            background: #f4f8fb;
            border: none;
            border-radius: 8px 8px 0 0;
            font-weight: 600;
            color: #0d6efd;
            cursor: pointer;
            font-size: 1.08rem;
            transition: background 0.2s, color 0.2s;
        }
        .ks-darkmode .report-tab { background: #23272b !important; color: #ffe082 !important; }
        .report-tab.active {
            background: #fff;
            color: #1565c0;
            border-bottom: 2.5px solid #1565c0;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .ks-darkmode .tab-content { background: #23272b !important; }
        .summary-box {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 1.5rem 1.2rem 1.2rem 1.2rem;
            margin-bottom: 1.5rem;
        }
        .ks-darkmode .summary-box {
            background: #23272b !important;
        }
        .summary-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 1.2rem;
        }
        .summary-item {
            flex: 1 1 180px;
            min-width: 180px;
            border-radius: 8px;
            padding: 1rem 1rem 0.7rem 1rem;
            text-align: center;
        }
        .summary-label { color: #888; font-size: 0.98rem; margin-bottom: 0.2rem; }
        .summary-value { font-size: 1.25rem; font-weight: bold; color: #1565c0; }
        .summary-year { font-size: 0.95rem; color: #888; margin-top: 0.2rem; }
        .summary-actions { text-align: right; margin-top: 1rem; }
        .dark-mode {
            background-color: #181a1b !important;
            color: #e0e0e0 !important;
        }
        .dark-mode .navbar-custom {
            background: #23272b !important;
            border-bottom: 1.5px solid #222 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
        }
        .dark-mode .navbar-title-text,
        .dark-mode .report-title,
        .dark-mode .summary-label,
        .dark-mode .report-tab,
        .dark-mode .card-header,
        .dark-mode .table thead th,
        .dark-mode .table-light th,
        .dark-mode label.form-label,
        .dark-mode .report-tab.active {
            color: #ffe082 !important;
            font-weight: bold !important;
            font-size: 1.08rem !important;
        }
        .dark-mode .table thead th,
        .dark-mode .table-light th {
            border-bottom: 2.5px solid #ffe082 !important;
        }
        .dark-mode .card-header.bg-primary,
        .dark-mode .card-header.bg-success,
        .dark-mode .card-header.bg-info {
            color: #fff !important;
        }
        .dark-mode .report-company {
            color: #90caf9 !important;
        }
        .dark-mode .navbar-menu a {
            color: #e0e0e0 !important;
        }
        .dark-mode .navbar-menu a.active, .dark-mode .navbar-menu a:hover {
            color: #90caf9 !important;
            border-bottom: 2.5px solid #90caf9 !important;
        }
        .dark-mode .navbar-account .account-toggle {
            color: #90caf9 !important;
        }
        .dark-mode .dropdown-menu, .dark-mode .account-dropdown {
            background: #23272b !important;
            color: #e0e0e0 !important;
            box-shadow: 0 8px 24px rgba(0,0,0,0.35);
        }
        .dark-mode .dropdown-menu a, .dark-mode .account-dropdown a {
            color: #e0e0e0 !important;
        }
        .dark-mode .dropdown-menu a:hover, .dark-mode .account-dropdown a:hover {
            background: #333 !important;
            color: #90caf9 !important;
        }
        .dark-mode .container, .dark-mode .dashboard-header, .dark-mode .card, .dark-mode .section-bg {
            background: #23272b !important;
            color: #e0e0e0 !important;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25) !important;
        }
        .dark-mode .card-title, .dark-mode .stat-title, .dark-mode .stat-value, .dark-mode .stat-year {
            color: #e0e0e0 !important;
        }
        .dark-mode .stat-icon {
            background: rgba(40,40,40,0.2) !important;
        }
        .dark-mode .bg-primary {
            background: linear-gradient(135deg, #283593 0%, #1565c0 100%) !important;
        }
        .dark-mode .bg-success {
            background: linear-gradient(135deg, #388e3c 0%, #1b5e20 100%) !important;
        }
        .dark-mode .bg-info {
            background: linear-gradient(135deg, #0288d1 0%, #01579b 100%) !important;
        }
        .dark-mode .bg-warning {
            background: linear-gradient(135deg, #fbc02d 0%, #f9a825 100%) !important;
            color: #23272b !important;
        }
        .dark-mode .bg-danger {
            background: linear-gradient(135deg, #b71c1c 0%, #e53935 100%) !important;
        }
        .dark-mode .bg-secondary {
            background: linear-gradient(135deg, #424242 0%, #212121 100%) !important;
        }
        .dark-mode .stat-card {
            border: 1px solid #333 !important;
        }
        .dark-mode .chart-card {
            background: #23272b !important;
        }
        .dark-mode .form-control, .dark-mode input, .dark-mode select, .dark-mode textarea {
            background: #23272b !important;
            color: #e0e0e0 !important;
            border: 1px solid #444 !important;
        }
        .dark-mode .form-control:focus, .dark-mode input:focus, .dark-mode select:focus, .dark-mode textarea:focus {
            background: #181a1b !important;
            color: #fff !important;
        }
        .dark-mode .text-muted {
            color: #b0b0b0 !important;
        }
        .dark-mode .border-0 {
            border: none !important;
        }
        .dark-mode .border {
            border: 1px solid #444 !important;
        }
        .dark-mode .dropdown-menu, .dark-mode .account-dropdown {
            border: 1px solid #333 !important;
        }
        .dark-mode .navbar-toggler {
            color: #90caf9 !important;
        }
        .dark-mode .fs-3, .dark-mode .fw-bold {
            color: #fff !important;
        }
        .dark-mode .fa-moon {
            color: #ffd600 !important;
        }
        .table td.right, .table th.right {
            text-align: right;
        }
        th.bg-primary, th.bg-success, th.bg-warning, th.bg-danger, th.bg-info, th.bg-secondary {
            color: #fff !important;
        }
        th, .table thead th, .table-light th { background: #f4f8fb; color: #0d6efd; }
    </style>
</head>
<body>
    <nav class="navbar-custom">
        <div class="navbar-content">
            <div class="navbar-left">
                <img src="logo.png" alt="Logo" class="navbar-logo">
                <span class="navbar-title-text">Hệ thống Khảo sát</span>
            </div>
            <div style="display: flex; align-items: center;">
                <div class="navbar-menu" id="navbarMenu">
                    <a href="index.html">Tổng quan</a>
                    <a href="khaosat.html">Khảo sát</a>
                    <a href="baocao.html" class="active">Báo cáo</a>
                    <a href="#">Cài đặt</a>
                </div>
                <div class="navbar-account dropdown">
                    <span class="account-toggle" onclick="toggleAccountDropdown(event)">
                        <i class="fas fa-user-circle"></i> <span id="accountName"></span> <i class="fas fa-caret-down"></i>
                    </span>
                    <div class="account-dropdown" id="accountDropdown">
                        <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Đăng xuất</a>
                    </div>
                </div>
                <button class="btn btn-link" id="darkModeToggle" title="Chế độ tối" style="font-size:1.4rem; color:#333; margin-right:0.5rem;"><i class="fas fa-moon"></i></button>
            </div>
        </div>
    </nav>
    <div class="container mt-4 mb-5">
        <h2 class="mb-4">Báo cáo kết quả khảo sát</h2>
        <div class="report-tabs">
            <button class="report-tab active" id="tabCaNhan" onclick="showTab('caNhan')">Báo cáo từng cá nhân</button>
            <button class="report-tab" id="tabTongHop" onclick="showTab('tongHop')">Báo cáo tổng hợp</button>
        </div>
        <div class="tab-content active" id="tabContentCaNhan">
            <div class="sidebar-filter mb-3">
                <div class="sidebar-filter-toggle" onclick="toggleFilter()">
                    <i class="fas fa-sliders-h me-2"></i> Bộ lọc <i class="fas fa-chevron-down ms-2" id="filterChevron"></i>
                </div>
                <div class="sidebar-filter-content" id="filterContent">
                    <form id="filterForm" class="row g-3 align-items-end">
                        <div class="col-md-3">
                            <label for="filterYear" class="form-label">Năm</label>
                            <select class="form-select" id="filterYear" name="filterYear">
                                <option value="">Tất cả</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="filterName" class="form-label">Tên</label>
                            <input type="text" class="form-control" id="filterName" name="filterName" placeholder="Nhập tên cần tìm...">
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100"><i class="fas fa-search me-1"></i> Lọc</button>
                        </div>
                    </form>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle" id="reportTable">
                    <thead class="table-light">
                        <tr>
                            <th onclick="sortTable(0)">STT</th>
                            <th onclick="sortTable(1)">Họ tên</th>
                            <th onclick="sortTable(2)">Năm</th>
                            <th onclick="sortTable(3)">Điện thoại</th>
                            <th onclick="sortTable(4)" class="right">Tổng chi phí</th>
                            <th onclick="sortTable(5)" class="right">Tổng thu nhập</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Dữ liệu sẽ được render ở đây -->
                    </tbody>
                </table>
            </div>
        </div>
        <div class="tab-content" id="tabContentTongHop">
            <div class="summary-box">
                <form class="row g-3 align-items-end mb-3" id="summaryForm">
                    <div class="col-md-3">
                        <label for="summaryYear" class="form-label">Chọn năm</label>
                        <select class="form-select" id="summaryYear" name="summaryYear"></select>
                    </div>
                </form>
                <div class="summary-row">
                    <div class="summary-item">
                        <div class="summary-label">Tổng số khảo sát</div>
                        <div class="summary-value" id="sumKhaoSat">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Tổng thành viên</div>
                        <div class="summary-value" id="sumThanhVien">0</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Tổng chi phí</div>
                        <div class="summary-value" id="sumChiPhi">0 VNĐ</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Tổng thu nhập</div>
                        <div class="summary-value" id="sumThuNhap">0 VNĐ</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Chi phí TB/hộ</div>
                        <div class="summary-value" id="sumChiPhiTB">0 VNĐ</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Thu nhập TB/hộ</div>
                        <div class="summary-value" id="sumThuNhapTB">0 VNĐ</div>
                    </div>
                </div>
                <div class="summary-actions">
                    <button class="btn btn-outline-primary me-2" type="button" onclick="printSummary()"><i class="fas fa-print me-1"></i> In</button>
                    <button class="btn btn-outline-danger" type="button" onclick="pdfSummary()"><i class="fas fa-file-pdf me-1"></i> PDF</button>
                </div>
            </div>
        </div>
    </div>
    <div class="home-button">
        <a href="index.html" class="btn btn-success btn-home" title="Về trang chủ">
            <i class="fas fa-home"></i>
        </a>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="js/darkmode.js"></script>
    <script>
        // Tab chuyển đổi
        function showTab(tab) {
            document.getElementById('tabCaNhan').classList.toggle('active', tab==='caNhan');
            document.getElementById('tabTongHop').classList.toggle('active', tab==='tongHop');
            document.getElementById('tabContentCaNhan').classList.toggle('active', tab==='caNhan');
            document.getElementById('tabContentTongHop').classList.toggle('active', tab==='tongHop');
        }
        // Ẩn/hiện sidebar filter
        function toggleFilter() {
            const content = document.getElementById('filterContent');
            const chevron = document.getElementById('filterChevron');
            if (content.classList.contains('hide')) {
                content.classList.remove('hide');
                chevron.classList.remove('fa-chevron-up');
                chevron.classList.add('fa-chevron-down');
            } else {
                content.classList.add('hide');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-up');
            }
        }
        // Dữ liệu mẫu, thay bằng fetch thực tế
        let surveyData = [];
        // Hàm fetch dữ liệu thực tế
        async function fetchData() {
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbxVjXAiM3-W3bxNUnmrx-BfZe1sIHAV9h3qhp7T2Y4IB4aEGalvvch6-l5qimz7u7jdsA/exec');
                const apiData = await response.json();
                if (apiData.status === 'success') {
                    surveyData = apiData.data.slice(1).map((row, idx) => ({
                        stt: idx + 1,
                        hoTen: row[6],
                        nam: new Date(row[1]).getFullYear(),
                        dienThoai: row[7] ? String(row[7]).padStart(10, '0') : '',
                        tongChiPhi: row[29],
                        tongThuNhap: row[32],
                        raw: row
                    }));
                    renderYearOptions();
                    renderTable(surveyData);
                }
            } catch (e) { console.error(e); }
        }
        // Render options năm
        function renderYearOptions() {
            const yearSet = new Set(surveyData.map(d => d.nam));
            const select = document.getElementById('filterYear');
            select.innerHTML = '<option value="">Tất cả</option>' + [...yearSet].sort().map(y => `<option value="${y}">${y}</option>`).join('');
        }
        // Lọc dữ liệu
        document.getElementById('filterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const year = document.getElementById('filterYear').value;
            const name = document.getElementById('filterName').value.trim().toLowerCase();
            let filtered = surveyData;
            if (year) filtered = filtered.filter(d => d.nam == year);
            if (name) filtered = filtered.filter(d => d.hoTen && d.hoTen.toLowerCase().includes(name));
            renderTable(filtered);
        });
        // Render bảng
        function renderTable(data) {
            const tbody = document.getElementById('reportTableBody');
            tbody.innerHTML = data.map((d, i) => `
                <tr>
                    <td>${i+1}</td>
                    <td>${d.hoTen||''}</td>
                    <td>${d.nam||''}</td>
                    <td>${d.dienThoai||''}</td>
                    <td class="right">${formatCurrency(d.tongChiPhi)}</td>
                    <td class="right">${formatCurrency(d.tongThuNhap)}</td>
                    <td class="action-btns">
                        <button class="btn btn-outline-primary btn-sm" onclick="printRow(${i})"><i class="fas fa-print"></i> In</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="pdfRow(${i})"><i class="fas fa-file-pdf"></i> PDF</button>
                    </td>
                </tr>
            `).join('');
        }
        // Sắp xếp bảng
        let sortCol = -1, sortAsc = true;
        function sortTable(colIdx) {
            if (sortCol === colIdx) sortAsc = !sortAsc; else { sortCol = colIdx; sortAsc = true; }
            const rows = Array.from(surveyData);
            const key = ['stt','hoTen','nam','dienThoai','tongChiPhi','tongThuNhap'][colIdx];
            rows.sort((a,b) => {
                if (a[key] < b[key]) return sortAsc ? -1 : 1;
                if (a[key] > b[key]) return sortAsc ? 1 : -1;
                return 0;
            });
            renderTable(rows);
            // Đánh dấu cột đang sort
            document.querySelectorAll('th').forEach((th,i)=>{
                th.classList.remove('sorted-asc','sorted-desc');
                if(i===colIdx) th.classList.add(sortAsc?'sorted-asc':'sorted-desc');
            });
        }
        // In/PDF dòng
        function printRow(idx) {
            const d = surveyData[idx];
            const r = d.raw;
            const data = {
                ngayKhaoSat: r[1],
                nguoiKhaoSat:[3],
                hoTen: r[6],
                dienThoai: d.dienThoai,
                viTri: r[8],
                diaChi: r[9],
                nguoiLon: r[10],
                treEm: r[11],
                tongThanhVien: r[12],
                loaiNhaO: r[13],
                chiPhiNhaO: r[14],
                gao: r[15],
                thit: r[16],
                ca: r[17],
                rauCu: r[18],
                sua: r[19],
                giaVi: r[20],
                nam: d.nam,
                email: r[10],
                gioiTinh: r[11],
                ngaySinh: r[15],
                hocPhi: r[21],
                sachVo: r[22],
                dongPhuc: r[23],
                khacGiaoDuc: r[24],
                dien: r[25],
                nuoc: r[26],
                internet: r[27],               
                xangXe: r[28],
                tongChiPhi: r[29],
                thuNhapChinh: r[30],
                thuNhapPhu: r[31],
                tongThuNhap: r[32],


            };
            window.open('temp_khaosat_nv.html?data=' + encodeURIComponent(JSON.stringify(data)), '_blank');
        }
        function pdfRow(idx) {
            const d = surveyData[idx];
            const r = d.raw;
            const data = {
                hoTen: r[6],
                viTri: r[8],
                tongThanhVien: r[12],
                nguoiLon: r[10],
                treEm: r[11],
                diaChi: r[9],
                nam: d.nam,
                dienThoai: d.dienThoai,
                email: r[10],
                gioiTinh: r[11],
                ngaySinh: r[15],
                cmnd: r[16],
                phongBan: r[17],
                chucVu: r[18],
                nhaTro: r[19],
                nguyenCan: r[20],
                nhaRieng: r[21],
                nhaKhac: r[22],
                loaiNhaO: r[13],
                chiPhiNhaO: r[24],
                gao: r[25],
                thit: r[26],
                ca: r[27],
                rauCu: r[28],
                sua: r[29],
                giaVi: r[30],
                truongMamNon: r[31],
                hocPhiMamNon: r[32],
                anBanTruMamNon: r[33],
                sachVoMamNon: r[34],
                khacMamNon: r[35],
                tongMamNon: r[36],
                truongTieuHoc: r[37],
                hocPhiTieuHoc: r[38],
                anBanTruTieuHoc: r[39],
                sachVoTieuHoc: r[40],
                khacTieuHoc: r[41],
                tongTieuHoc: r[42],
                truongTHPT: r[43],
                hocPhiTHPT: r[44],
                anBanTruTHPT: r[45],
                sachVoTHPT: r[46],
                khacTHPT: r[47],
                tongTHPT: r[48],
                truongDaiHoc: r[49],
                hocPhiDaiHoc: r[50],
                anBanTruDaiHoc: r[51],
                sachVoDaiHoc: r[52],
                khacDaiHoc: r[53],
                tongDaiHoc: r[54],
                tongHocPhi: r[55],
                tongAnBanTru: r[56],
                tongSachVo: r[57],
                tongKhacGiaoDuc: r[58],
                tongGiaoDuc: r[59],
                hocPhi: r[60],
                sachVo: r[61],
                dongPhuc: r[62],
                khacGiaoDuc: r[63],
                baoHiemYTe: r[64],
                chuaBenh: r[65],
                tongYTe: r[66],
                dien: r[67],
                gas: r[68],
                nuoc: r[69],
                xangXe: r[70],
                internet: r[71],
                tienIchKhac: r[72],
                rac: r[73],
                thuNhapChinh: r[74],
                thuNhapNguoiThan: r[75],
                thuNhapPhu: r[76],
                thuNhapKhacNguoiThan: r[77],
                tongChiPhiAnUong: r[78],
                tongChiPhiGiaoDuc: r[79],
                tongChiPhiTienIch: r[80],
                tongChiPhiSinhHoat: r[81],
                tongChiPhi: d.tongChiPhi,
                tongThuNhap: d.tongThuNhap,
                chenhLech: r[82],
                recommendedSalary: r[83],
                nguoiKhaoSat: r[84],
                ngayKhaoSat: r[85],
                ghiChu: r[86],
                mainGhiChu: r[87]
            };
            window.open('temp_khaosat_nv.html?data=' + encodeURIComponent(JSON.stringify(data)), '_blank');
        }
        // Tổng hợp theo năm
        function updateSummary(year) {
            let filtered = surveyData;
            if (year) filtered = filtered.filter(d => d.nam == year);
            const tongKhaoSat = filtered.length;
            const tongThanhVien = filtered.reduce((sum, d) => sum + (parseInt(d.raw[12])||0), 0);
            const tongChiPhi = filtered.reduce((sum, d) => sum + (parseFloat((d.tongChiPhi||'0').toString().replace(/\./g, '').replace(',', '.'))||0), 0);
            const tongThuNhap = filtered.reduce((sum, d) => sum + (parseFloat((d.tongThuNhap||'0').toString().replace(/\./g, '').replace(',', '.'))||0), 0);
            const chiPhiTB = tongKhaoSat ? tongChiPhi / tongKhaoSat : 0;
            const thuNhapTB = tongKhaoSat ? tongThuNhap / tongKhaoSat : 0;
            document.getElementById('sumKhaoSat').textContent = tongKhaoSat.toLocaleString('vi-VN');
            document.getElementById('sumThanhVien').textContent = tongThanhVien.toLocaleString('vi-VN');
            document.getElementById('sumChiPhi').textContent = tongChiPhi.toLocaleString('vi-VN') + ' VNĐ';
            document.getElementById('sumThuNhap').textContent = tongThuNhap.toLocaleString('vi-VN') + ' VNĐ';
            document.getElementById('sumChiPhiTB').textContent = Math.round(chiPhiTB).toLocaleString('vi-VN') + ' VNĐ';
            document.getElementById('sumThuNhapTB').textContent = Math.round(thuNhapTB).toLocaleString('vi-VN') + ' VNĐ';
        }
        document.getElementById('summaryYear').addEventListener('change', function() {
            updateSummary(this.value);
        });
        // Render options năm cho tổng hợp
        function renderSummaryYearOptions() {
            const yearSet = new Set(surveyData.map(d => d.nam));
            const select = document.getElementById('summaryYear');
            select.innerHTML = [...yearSet].sort().map(y => `<option value="${y}">${y}</option>`).join('');
            if (select.value) updateSummary(select.value); else if (select.options.length) updateSummary(select.options[0].value);
        }
        // Khi fetch xong dữ liệu, render luôn options năm tổng hợp
        const oldFetchData = fetchData;
        fetchData = async function() {
            await oldFetchData();
            renderSummaryYearOptions();
        };
        // Xuất PDF/in tổng hợp
        function printSummary() {
            const year = document.getElementById('summaryYear').value;
            const html = `
                <html><head><title>Báo cáo tổng hợp</title><style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .report-logo { height: 48px; margin-bottom: 8px; }
                .report-title { font-size: 1.3rem; font-weight: bold; color: #0d6efd; margin-bottom: 0.5rem; }
                .report-company { font-size: 1.1rem; color: #333; margin-bottom: 0.5rem; }
                .summary-row { display: flex; flex-wrap: wrap; gap: 1.5rem; margin-bottom: 1.2rem; }
                .summary-item { flex: 1 1 180px; min-width: 180px; background: #f4f8fb; border-radius: 8px; padding: 1rem 1rem 0.7rem 1rem; text-align: center; }
                .summary-label { color: #888; font-size: 0.98rem; margin-bottom: 0.2rem; }
                .summary-value { font-size: 1.25rem; font-weight: bold; color: #0d6efd; }
                </style></head><body>
                <img src='logo.png' class='report-logo'>
                <div class='report-company'>CÔNG TY ABC</div>
                <div class='report-title'>BÁO CÁO TỔNG HỢP KHẢO SÁT NĂM ${year}</div>
                <div class='summary-row'>
                    <div class='summary-item'><div class='summary-label'>Tổng số khảo sát</div><div class='summary-value'>${document.getElementById('sumKhaoSat').textContent}</div></div>
                    <div class='summary-item'><div class='summary-label'>Tổng thành viên</div><div class='summary-value'>${document.getElementById('sumThanhVien').textContent}</div></div>
                    <div class='summary-item'><div class='summary-label'>Tổng chi phí</div><div class='summary-value'>${document.getElementById('sumChiPhi').textContent}</div></div>
                    <div class='summary-item'><div class='summary-label'>Tổng thu nhập</div><div class='summary-value'>${document.getElementById('sumThuNhap').textContent}</div></div>
                    <div class='summary-item'><div class='summary-label'>Chi phí TB/hộ</div><div class='summary-value'>${document.getElementById('sumChiPhiTB').textContent}</div></div>
                    <div class='summary-item'><div class='summary-label'>Thu nhập TB/hộ</div><div class='summary-value'>${document.getElementById('sumThuNhapTB').textContent}</div></div>
                </div>
                <div style='margin-top:2.5rem;display:flex;justify-content:space-between;'>
                    <div style='width:45%;text-align:center;'><span style='font-style:italic;color:#888;'>Người thực hiện</span><div style='height:60px;border-bottom:1px dotted #bbb;margin-bottom:0.3rem;'></div></div>
                    <div style='width:45%;text-align:center;'><span style='font-style:italic;color:#888;'>Người duyệt</span><div style='height:60px;border-bottom:1px dotted #bbb;margin-bottom:0.3rem;'></div></div>
                </div>
                </body></html>
            `;
            const win = window.open('', '', 'width=900,height=700');
            win.document.write(html);
            win.document.close();
            win.print();
        }
        function pdfSummary() {
            const year = document.getElementById('summaryYear').value;
            const doc = new window.jspdf.jsPDF();
            doc.addImage('logo.png', 'PNG', 80, 8, 50, 18);
            doc.setFontSize(14);
            doc.text('CÔNG TY ABC', 105, 32, { align: 'center' });
            doc.setFontSize(18);
            doc.setTextColor(13,110,253);
            doc.text(`BÁO CÁO TỔNG HỢP KHẢO SÁT NĂM ${year}`, 105, 45, { align: 'center' });
            doc.setFontSize(13);
            doc.setTextColor(0,0,0);
            let y = 60;
            doc.text(`Tổng số khảo sát: ${document.getElementById('sumKhaoSat').textContent}`, 20, y); y+=10;
            doc.text(`Tổng thành viên: ${document.getElementById('sumThanhVien').textContent}`, 20, y); y+=10;
            doc.text(`Tổng chi phí: ${document.getElementById('sumChiPhi').textContent}`, 20, y); y+=10;
            doc.text(`Tổng thu nhập: ${document.getElementById('sumThuNhap').textContent}`, 20, y); y+=10;
            doc.text(`Chi phí TB/hộ: ${document.getElementById('sumChiPhiTB').textContent}`, 20, y); y+=10;
            doc.text(`Thu nhập TB/hộ: ${document.getElementById('sumThuNhapTB').textContent}`, 20, y); y+=10;
            doc.text('Người thực hiện', 35, y+30);
            doc.text('Người duyệt', 135, y+30);
            doc.line(25, y+28, 75, y+28);
            doc.line(125, y+28, 175, y+28);
            doc.save(`baocao_tonghop_${year}.pdf`);
        }
        // Khởi tạo
        fetchData();
        // Hiển thị tên người dùng
        (function() {
            let user = {};
            try { user = JSON.parse(localStorage.getItem('ks_user') || '{}'); } catch(e){}
            document.getElementById('accountName').textContent = user.ten_day_du || user.name || user.username || '';
        })();
        function toggleAccountDropdown(e) {
            e.stopPropagation();
            document.getElementById('accountDropdown').classList.toggle('show');
        }
        function logout() {
            localStorage.removeItem('ks_logged_in');
            localStorage.removeItem('ks_user');
            window.location.href = 'login.html';
        }
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.navbar-account')) {
                document.getElementById('accountDropdown').classList.remove('show');
            }
        });
        // Thêm hàm định dạng số phần ngàn
        function formatCurrency(val) {
            if (val == null || val === '') return '';
            let num = Number(String(val).replace(/[^\d.-]/g, ''));
            if (isNaN(num)) return val;
            return num.toLocaleString('vi-VN');
        }
    </script>
</body>
</html> 
